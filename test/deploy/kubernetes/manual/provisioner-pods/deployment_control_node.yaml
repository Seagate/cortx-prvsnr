apiVersion: v1
kind: Pod
metadata:
  name: control-node
  labels:
    app: control-node
    id: 285d6133-3645-46b7-96a7-56917cd3cb43
spec:
  hostname: control-node
  restartPolicy: Never
  nodeSelector:
    node-name: node1
  volumes:
  - name: solution-config
    configMap:
      name: solution-config
  - name: etc-cortx-1
    persistentVolumeClaim:
      claimName: etc-cortx-1
  - name: cortx-secret
    secret:
      secretName: cortx-secret
  - name: var-data-cortx-1
    persistentVolumeClaim:
      claimName: var-data-cortx-1
  - name: var-log-cortx-1
    persistentVolumeClaim:
      claimName: var-log-cortx-1
  containers:
  - name: cortx-control-node
    image: ghcr.io/seagate/cortx-all:2.0.0-latest-custom-ci
    imagePullPolicy: IfNotPresent
    env:
    - name: NODE_ID
      valueFrom:
        fieldRef:
          fieldPath: metadata.labels['id']
    - name: CONFIG_INFO
      value: "yaml:///etc/cortx/solution/config.yaml"
    - name: CLUSTER_INFO
      value: "yaml:///etc/cortx/solution/cluster.yaml"
    - name: CORTX_CONFIG
      value: "yaml:///etc/cortx/cluster.conf"
    args:
    - /bin/sh
    - -c
    - set -x;
      export PATH=$PATH:/opt/seagate/cortx/provisioner/bin;
      echo $NODE_ID > "/etc/machine-id";
      cat /etc/machine-id;
      cortx_setup config apply -f $CLUSTER_INFO -o $CORTX_CONFIG;
      cortx_setup config apply -f $CONFIG_INFO -o $CORTX_CONFIG;
      echo -e "#!/bin/bash\necho $*" > /usr/bin/motr_setup;
      chmod +x /usr/bin/motr_setup;
      cp -pf /usr/bin/motr_setup /usr/bin/s3_setup;
      cp -pf /usr/bin/motr_setup /usr/bin/hare_setup;
      cp -pf /usr/bin/motr_setup /usr/bin/csm_setup;
      cp -pf /usr/bin/motr_setup /usr/bin/utils_setup;
      cortx_setup cluster bootstrap -f  $CORTX_CONFIG;
      ls /etc/cortx;
      cat /etc/cortx/cluster.conf;
      ls -l /etc/cortx/solution;
      while true; do sleep 30; echo "Hello Kubernetes"; done;
    volumeMounts:
    - name: solution-config
      mountPath: /etc/cortx/solution
    - name: etc-cortx-1
      mountPath: /etc/cortx
    - name: var-data-cortx-1
      mountPath: /var/data/cortx
    - name: var-log-cortx-1
      mountPath: /var/log/cortx
    - name: cortx-secret
      mountPath: /etc/cortx/solution/secret
